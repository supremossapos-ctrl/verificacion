<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Authenticity Verification</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;padding:24px;max-width:720px}
    h1{margin:0 0 10px 0}
    .title{font-size:34px;font-weight:900;margin:14px 0 10px 0}
    .card{border:1px solid #e5e5e5;border-radius:14px;padding:16px}
    .big{font-size:30px;font-weight:900;margin-top:10px}
    .meta{color:#444;margin-top:10px;line-height:1.45}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h1>Authenticity Verification</h1>
  <div class="card">
    <div id="productTitle" class="title"></div>
    <div id="status" class="big">Checkingâ€¦</div>
    <div id="meta" class="meta"></div>
  </div>

<script>

const PUBLIC_KEY_PEM = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAugMJ76e+l3g7DepjOdzE
S0FKgnaWM7jlSsUfCjqNUz6qHxmurZfOiPreHywxy5jodZyR96ZZf631PqK6UUai
zMG2xMf8YpB4Qljo5vmrI5Pw4pJpIxmevAe9/YhoJImQI8hJcqmWw9mgiYGs4Yk2
uUjKgPud5NUVE5rv17a3OHbv+oOLTH120VsTT+VPs2jcFTXXiXDSiWmza6IXGkhk
38/yGrGh4FKrOBJ57Dk9O2RwnR98wu5zF7hhKOQHbzOEnZFq0kk00gn/GHGrfJwY
rfBeLL6n3Bdr3UKwmBL5S7xE/W33A9JW5gt3+no2waQFsTwDahorjLIzJ4nHsSeV
8wIDAQAB
-----END PUBLIC KEY-----`;

function q(name){ return new URL(location.href).searchParams.get(name) || ""; }

function b64urlToBytes(b64url){
  const b64 = b64url.replace(/-/g,"+").replace(/_/g,"/") + "===".slice((b64url.length + 3) % 4);
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return bytes;
}

function pemToArrayBuffer(pem){
  const b64 = pem.replace(/-----.*-----/g,"").replace(/\s+/g,"");
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return bytes.buffer;
}

async function run(){
  // Your existing links use:
  // c=code, s=signature, m=brand, p=product(we will use this as QUALITY), l=batch
  const code = q("c").trim();
  const brand = q("m").trim();
  const quality = q("p").trim(); // <-- product title depends on quality
  const batch = q("l").trim();
  const sig = q("s").trim();

  const statusEl = document.getElementById("status");
  const metaEl = document.getElementById("meta");
  const titleEl = document.getElementById("productTitle");

  titleEl.textContent = quality ? quality : "Product";

  if(!code || !sig){
    statusEl.textContent = "FAKE";
    metaEl.textContent = "Incomplete link.";
    return;
  }

  // Same signature message format you already use:
  const msg = `${code}|${brand}|${quality}|${batch}`;

  try{
    const key = await crypto.subtle.importKey(
      "spki",
      pemToArrayBuffer(PUBLIC_KEY_PEM),
      { name:"RSA-PSS", hash:"SHA-256" },
      false,
      ["verify"]
    );

    const ok = await crypto.subtle.verify(
      { name:"RSA-PSS", saltLength:32 },
      key,
      b64urlToBytes(sig),
      new TextEncoder().encode(msg)
    );

    if(ok){
      statusEl.textContent = "AUTHENTIC";
      metaEl.innerHTML =
        `Code: <code>${code}</code><br>` +
        `Brand: ${brand}<br>` +
        `Quality: ${quality}<br>` +
        `Batch: ${batch}`;
    }else{
      statusEl.textContent = "FAKE";
      metaEl.textContent = "Invalid signature.";
    }
  }catch(e){
    statusEl.textContent = "ERROR";
    metaEl.textContent = "Verification failed (public key not pasted correctly or unsupported browser).";
  }
}

run();
</script>
</body>
</html>
