<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Verificación</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;padding:24px;max-width:720px}
    .card{border:1px solid #e5e5e5;border-radius:14px;padding:16px}
    .big{font-size:30px;font-weight:900;margin-top:10px}
    .meta{color:#444;margin-top:10px;line-height:1.45}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h1>Verificación de autenticidad</h1>
  <div class="card">
    <div id="status" class="big">Comprobando…</div>
    <div id="meta" class="meta"></div>
  </div>

<script>
const PUBLIC_KEY_PEM = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAugMJ76e+l3g7DepjOdzE
S0FKgnaWM7jlSsUfCjqNUz6qHxmurZfOiPreHywxy5jodZyR96ZZf631PqK6UUai
zMG2xMf8YpB4Qljo5vmrI5Pw4pJpIxmevAe9/YhoJImQI8hJcqmWw9mgiYGs4Yk2
uUjKgPud5NUVE5rv17a3OHbv+oOLTH120VsTT+VPs2jcFTXXiXDSiWmza6IXGkhk
38/yGrGh4FKrOBJ57Dk9O2RwnR98wu5zF7hhKOQHbzOEnZFq0kk00gn/GHGrfJwY
rfBeLL6n3Bdr3UKwmBL5S7xE/W33A9JW5gt3+no2waQFsTwDahorjLIzJ4nHsSeV
8wIDAQAB
-----END PUBLIC KEY-----`;

function q(name){ return new URL(location.href).searchParams.get(name) || ""; }

function b64urlToBytes(b64url){
  const b64 = b64url.replace(/-/g,"+").replace(/_/g,"/") + "===".slice((b64url.length + 3) % 4);
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return bytes;
}

function pemToArrayBuffer(pem){
  const b64 = pem.replace(/-----.*-----/g,"").replace(/\s+/g,"");
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return bytes.buffer;
}

async function run(){
  const code = q("c").trim();
  const marca = q("m").trim();
  const producto = q("p").trim();
  const lote = q("l").trim();
  const sig = q("s").trim();

  const statusEl = document.getElementById("status");
  const metaEl = document.getElementById("meta");

  if(!code || !sig){
    statusEl.textContent = "FALSO";
    metaEl.textContent = "Enlace incompleto.";
    return;
  }

  const msg = `${code}|${marca}|${producto}|${lote}`;

  try{
    const key = await crypto.subtle.importKey(
      "spki",
      pemToArrayBuffer(PUBLIC_KEY_PEM),
      { name:"RSA-PSS", hash:"SHA-256" },
      false,
      ["verify"]
    );

    const ok = await crypto.subtle.verify(
      { name:"RSA-PSS", saltLength:32 },
      key,
      b64urlToBytes(sig),
      new TextEncoder().encode(msg)
    );

    if(ok){
      statusEl.textContent = "REAL";
      metaEl.innerHTML = `Código: <code>${code}</code><br>Marca: ${marca}<br>Producto: ${producto}<br>Lote: ${lote}`;
    }else{
      statusEl.textContent = "FALSO";
      metaEl.textContent = "Firma inválida (código no auténtico).";
    }
  }catch(e){
    statusEl.textContent = "ERROR";
    metaEl.textContent = "No se pudo verificar (clave pública mal pegada o navegador incompatible).";
  }
}

run();
</script>
</body>
</html>
