<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>STREETZ FARMZ — Chooser</title>
  <meta name="theme-color" content="#0b0b0f"/>
  <style>
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0b0f; color:#fff;}
    .box{max-width:820px; margin:0 auto; padding:22px 16px;}
    .card{background:rgba(255,255,255,.04); border:1px solid rgba(255,138,0,.35); border-radius:16px; padding:16px;}
    code{background:rgba(255,255,255,.07); padding:2px 7px; border-radius:8px; white-space:nowrap;}
  </style>
</head>
<body>
<div class="box">
  <div class="card">
    <h2>Loading…</h2>
    <p id="msg">Selecting a valid QR from the quality pool.</p>
  </div>
</div>

<script>
function q(name){ return new URL(location.href).searchParams.get(name) || ""; }

const QUALITY_SLUG_TO_LABEL = {
  "frozen": "Frozen",
  "premium-frozen": "Premium Frozen",
  "static": "Static",
  "premium-static": "Premium Static",
  "drysift": "Drysift",
  "premium-drysift": "Premium Drysift",
  "fresh-frozen-static": "Fresh Frozen Static",
  "premium-fresh-frozen-static": "Premium Fresh Frozen Static"
};

function pickRandom(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

async function run(){
  const slug = (q("q") || "").trim().toLowerCase();
  const label = QUALITY_SLUG_TO_LABEL[slug];

  const msg = document.getElementById("msg");

  if(!label){
    msg.innerHTML = Missing/invalid quality. Use: <code>?q=frozen</code> (etc).;
    return;
  }

  const poolUrl = assets/pools/${slug}.json?v=${Date.now()};
  msg.textContent = Loading pool: ${poolUrl};

  let data;
  try{
    const res = await fetch(poolUrl, {cache:"no-store"});
    if(!res.ok) throw new Error(HTTP ${res.status});
    data = await res.json();
  }catch(e){
    msg.innerHTML = Could not load <code>${poolUrl}</code>. Check that the JSON exists in <code>assets/pools</code>.;
    return;
  }

  const items = Array.isArray(data) ? data : (data.items || []);
  if(!items.length){
    msg.innerHTML = Pool file <code>${poolUrl}</code> is empty.;
    return;
  }

  const it = pickRandom(items);

  const code  = (it.c || it.code || "").trim();
  const sig   = (it.s || it.sig  || it.signature || "").trim();
  const brand = (it.m || it.brand || "STREETZ FARMZ").trim();
  const batch = (it.l || it.batch || "").trim();

  if(!code || !sig){
    msg.innerHTML = Selected item missing <code>code</code> or <code>sig</code> in <code>${poolUrl}</code>.;
    return;
  }

  const params = new URLSearchParams();
  params.set("c", code);
  params.set("s", sig);
  params.set("m", brand);
  params.set("p", label);     // <- esto controla la UI de verify.html
  params.set("l", batch);

  location.href = verify.html?${params.toString()};
}

run();
</script>
</body>
</html>
